name: Bump version, build and deploy main to Test
run-name: Bump version, build and deploy main to Test by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: Dry run
        type: boolean
        default: true
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
      - 'apps/**'
      - '.gitignore'
      - '**.md'
      - '**.iml'

jobs:
  bump:
    if: |
      github.event.pull_request.user.login != 'dependabot[bot]' &&
      (github.event.pull_request.merged || github.event_name == 'workflow_dispatch' || github.event_name == 'push')
    runs-on: ubuntu-latest
    permissions:
      contents: 'write'
      actions: 'read'
    outputs:
      version: ${{ steps.bump.outputs.new_tag }}
      changed-frontend: ${{ steps.changed-frontend.outputs.changed != 'non-inputs' }}
      changed-xp-backend: ${{ steps.changed-xp-backend.outputs.changed != 'non-inputs' }}
      changed-search-api: ${{ steps.changed-search-api.outputs.changed != 'non-inputs' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0 # Fetch all history for what-changed action

      - name: Bump version and push tag
        id: bump
        uses: anothrNick/github-tag-action@1.73.0
        env:
          DEFAULT_BUMP: patch
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_BRANCHES: main
          WITH_V: true
          DRY_RUN: ${{ inputs.dry_run }}

      - name: Creating summary
        run: |
          if ${{ steps.bump.outputs.new_tag == steps.bump.outputs.old_tag }}; then
            echo "### âŒ Did not bump âŒ Current version: ${{ steps.bump.outputs.old_tag }}" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### Bumped version to ${{ steps.bump.outputs.new_tag }} ðŸ‘Š" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check if frontend files have changed
        id: changed-frontend
        uses: nais/what-changed@main
        with:
          files: frontend/**
      - name: Check if xp-backend files have changed
        id: changed-xp-backend
        uses: nais/what-changed@main
        with:
          files: xp-backend/**
      - name: Check if search-api files have changed
        id: changed-search-api
        uses: nais/what-changed@main
        with:
          files: apps/idebanken-search-api/**

  xp-app-build-and-upload:
    name: Build and upload artifact
    needs: bump
    if: needs.bump.result == 'success' && needs.bump.outputs.changed-xp-backend == 'true'
    secrets: inherit
    uses: ./.github/workflows/xp-app-build-upload.yml
    with:
      version: ${{ needs.bump.outputs.version }}

  xp-app-download-and-deploy:
    name: Download artifact and deploy to Test
    needs: [xp-app-build-and-upload, bump]
    if: needs.xp-app-build-and-upload.result == 'success'
    secrets: inherit
    uses: ./.github/workflows/xp-app-download-deploy.yml
    permissions:
      contents: 'read'
      packages: 'read'
      actions: 'read'
    with:
      version: ${{ needs.bump.outputs.version }}
      environment: test

  frontend-build-and-deploy:
    name: Build and upload frontend artifact
    needs: [xp-app-download-and-deploy, bump]
    if: |
      needs.bump.outputs.changed-frontend == 'true' && 
      (needs.xp-app-download-and-deploy.result == 'success' || needs.xp-app-download-and-deploy.result == 'skipped')
    secrets: inherit
    uses: ./.github/workflows/frontend-build-deploy.yml
    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'read'
    with:
      version: ${{ needs.bump.outputs.version }}
      environment: test

  search-api-build-and-deploy:
    name: Build and deploy search-api
    needs: bump
    if: needs.bump.result == 'success' && needs.bump.outputs.changed-search-api == 'true'
    uses: ./.github/workflows/app-build-and-deploy.yml
    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'read'
    with:
      environment: test
      app_directory: idebanken-search-api
      version: ${{ needs.bump.outputs.version }}
